name: Scheduled Merge and Deploy

on:
  # Run twice a week (Monday and Thursday) at 2 AM UTC
  # This frequency should stay within Render and Vercel free tier limits
  schedule:
    - cron: '0 2 * * 1,4'
  
  # Allow manual triggering
  workflow_dispatch:
    inputs:
      force_merge:
        description: 'Force merge approved PRs'
        type: boolean
        default: false
      deploy_target:
        description: 'Deploy target'
        type: choice
        options:
          - all
          - render
          - vercel
        default: 'all'

# Permissions needed for PR merging and deployments
permissions:
  contents: write
  pull-requests: write
  deployments: write

jobs:
  # Identify and merge approved PRs
  merge-approved-prs:
    name: Merge Approved PRs
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup Git identity
        run: |
          git config --global user.name "KONIVRER Automation"
          git config --global user.email "automation@konivrer.com"
      
      - name: Find and merge approved PRs
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const forceMode = '${{ github.event.inputs.force_merge }}' === 'true';
            
            // Get open PRs
            const { data: pullRequests } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              sort: 'updated',
              direction: 'desc'
            });
            
            console.log(`Found ${pullRequests.length} open PRs`);
            
            // Track PRs we'll merge
            const prsToMerge = [];
            
            for (const pr of pullRequests) {
              // Skip draft PRs
              if (pr.draft) {
                console.log(`PR #${pr.number} is a draft, skipping`);
                continue;
              }
              
              // Get PR reviews
              const { data: reviews } = await github.rest.pulls.listReviews({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr.number
              });
              
              // Check if PR is approved
              const isApproved = reviews.some(review => review.state === 'APPROVED');
              
              // Check if PR has any blocking reviews
              const hasBlockingReviews = reviews.some(review => 
                review.state === 'REQUEST_CHANGES' && 
                !reviews.some(r => r.user.id === review.user.id && 
                              r.state === 'APPROVED' && 
                              r.submitted_at > review.submitted_at)
              );
              
              // Check if PR has merge conflicts
              const hasMergeConflicts = pr.mergeable === false;
              
              // Check if PR has required checks
              const { data: checkRuns } = await github.rest.checks.listForRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref: pr.head.sha
              });
              
              const hasFailedChecks = checkRuns.check_runs.some(check => 
                check.conclusion === 'failure' || check.conclusion === 'cancelled'
              );
              
              // Determine if PR can be merged
              const canMerge = (isApproved || forceMode) && 
                              !hasBlockingReviews && 
                              !hasMergeConflicts && 
                              !hasFailedChecks;
              
              console.log(`PR #${pr.number}: approved=${isApproved}, blocking=${hasBlockingReviews}, conflicts=${hasMergeConflicts}, failed checks=${hasFailedChecks}, can merge=${canMerge}`);
              
              if (canMerge) {
                prsToMerge.push(pr);
              }
            }
            
            // Merge PRs (limit to 3 per run to avoid overwhelming the system)
            const mergeLimit = Math.min(prsToMerge.length, 3);
            console.log(`Will merge ${mergeLimit} PRs`);
            
            for (let i = 0; i < mergeLimit; i++) {
              const pr = prsToMerge[i];
              try {
                await github.rest.pulls.merge({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: pr.number,
                  merge_method: 'squash',
                  commit_title: `${pr.title} (#${pr.number})`,
                  commit_message: `${pr.body}\n\nAutomatically merged by scheduled workflow.`
                });
                console.log(`Successfully merged PR #${pr.number}`);
                
                // Add comment to PR
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: pr.number,
                  body: 'ðŸ¤– This PR was automatically merged by the scheduled workflow.'
                });
              } catch (error) {
                console.error(`Failed to merge PR #${pr.number}: ${error.message}`);
              }
            }

  # Build and deploy to Render
  deploy-to-render:
    name: Deploy to Render
    runs-on: ubuntu-latest
    needs: merge-approved-prs
    if: always() && (needs.merge-approved-prs.result == 'success' || needs.merge-approved-prs.result == 'skipped') && (github.event.inputs.deploy_target == 'all' || github.event.inputs.deploy_target == 'render')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build
        run: npm run build
      
      - name: Deploy to Render
        run: |
          echo "Deploying to Render..."
          # Render automatically deploys when changes are pushed to the main branch
          # You can also use a deploy hook if you have one configured
          if [ -n "${{ secrets.RENDER_DEPLOY_HOOK_URL }}" ]; then
            curl -X POST "${{ secrets.RENDER_DEPLOY_HOOK_URL }}"
            echo "Triggered Render deploy hook"
          else
            echo "No Render deploy hook configured, relying on automatic deployment"
          fi

  # Build and deploy to Vercel
  deploy-to-vercel:
    name: Deploy to Vercel
    runs-on: ubuntu-latest
    needs: merge-approved-prs
    if: always() && (needs.merge-approved-prs.result == 'success' || needs.merge-approved-prs.result == 'skipped') && (github.event.inputs.deploy_target == 'all' || github.event.inputs.deploy_target == 'vercel')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Install Vercel CLI
        run: npm install -g vercel
      
      - name: Deploy to Vercel
        run: |
          echo "Deploying to Vercel..."
          if [ -n "${{ secrets.VERCEL_TOKEN }}" ]; then
            vercel --token "${{ secrets.VERCEL_TOKEN }}" --prod
            echo "Deployed to Vercel"
          else
            echo "No Vercel token configured, skipping deployment"
          fi
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}

  # Notify about deployment status
  notify-deployment:
    name: Notify Deployment Status
    runs-on: ubuntu-latest
    needs: [deploy-to-render, deploy-to-vercel]
    if: always()
    
    steps:
      - name: Generate deployment report
        uses: actions/github-script@v7
        with:
          script: |
            const renderResult = '${{ needs.deploy-to-render.result }}';
            const vercelResult = '${{ needs.deploy-to-vercel.result }}';
            
            const renderStatus = renderResult === 'success' ? 'âœ…' : 
                               renderResult === 'skipped' ? 'â­ï¸' : 'âŒ';
            
            const vercelStatus = vercelResult === 'success' ? 'âœ…' : 
                               vercelResult === 'skipped' ? 'â­ï¸' : 'âŒ';
            
            const report = `
            ## ðŸš€ Deployment Report
            
            **Triggered by:** ${{ github.event_name }}
            **Timestamp:** ${new Date().toISOString()}
            
            ### Deployment Status
            - ${renderStatus} Render: ${renderResult}
            - ${vercelStatus} Vercel: ${vercelResult}
            
            ${(renderResult === 'failure' || vercelResult === 'failure') ? 
              'âš ï¸ **Action Required:** Some deployments failed.' : 
              'âœ… All deployments completed successfully!'}
            `;
            
            console.log(report);
            
            // Create an issue if deployments failed during scheduled run
            if ((renderResult === 'failure' || vercelResult === 'failure') && 
                '${{ github.event_name }}' === 'schedule') {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'ðŸš¨ Scheduled Deployment Failures',
                body: report,
                labels: ['deployment', 'failure']
              });
            }