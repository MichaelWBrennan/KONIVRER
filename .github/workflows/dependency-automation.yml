
name: ğŸ”„ Dependency Update Automation

on:
  schedule:
    - cron: '0 3 * * 1'  # Weekly on Monday at 3 AM
  workflow_dispatch:
    inputs:
      update_type:
        description: 'Type of updates to perform'
        required: true
        default: 'patch'
        type: choice
        options:
        - patch
        - minor
        - major
        - security

jobs:
  update-dependencies:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: ğŸ“¦ Install current dependencies
      run: npm ci

    - name: ğŸ” Check for outdated packages
      run: |
        echo "## Current Outdated Packages" >> $GITHUB_STEP_SUMMARY
        npm outdated || echo "No outdated packages found"

    - name: ğŸ”„ Update dependencies (Patch)
      if: github.event.inputs.update_type == 'patch' || github.event.inputs.update_type == ''
      run: |
        echo "Updating patch versions only..."
        npx npm-check-updates -u --target patch
        npm install

    - name: ğŸ”„ Update dependencies (Minor)
      if: github.event.inputs.update_type == 'minor'
      run: |
        echo "Updating minor versions..."
        npx npm-check-updates -u --target minor
        npm install

    - name: ğŸ”„ Update dependencies (Major)
      if: github.event.inputs.update_type == 'major'
      run: |
        echo "âš ï¸ Updating major versions - requires manual review!"
        npx npm-check-updates -u --target major
        npm install

    - name: ğŸ›¡ï¸ Security updates
      if: github.event.inputs.update_type == 'security' || github.event.inputs.update_type == ''
      run: |
        echo "Applying security fixes..."
        npm audit fix --force || echo "No security fixes available"

    - name: ğŸ§ª Run tests
      run: |
        echo "Running test suite..."
        npm run test || echo "âš ï¸ Tests failed - manual review required"
      continue-on-error: true

    - name: ğŸ—ï¸ Test build
      run: |
        echo "Testing build process..."
        npm run build || echo "âš ï¸ Build failed - manual review required"
      continue-on-error: true

    - name: ğŸ“Š Generate update report
      run: |
        echo "## Dependency Update Report" >> update-report.md
        echo "Update type: ${{ github.event.inputs.update_type || 'patch + security' }}" >> update-report.md
        echo "Date: $(date)" >> update-report.md
        echo "" >> update-report.md
        echo "### Changes:" >> update-report.md
        git diff --name-only package*.json >> update-report.md || echo "No package changes"
        echo "" >> update-report.md
        echo "### Test Results:" >> update-report.md
        echo "- Build: $(npm run build > /dev/null 2>&1 && echo 'âœ… Passed' || echo 'âŒ Failed')" >> update-report.md
        echo "- Tests: $(npm run test > /dev/null 2>&1 && echo 'âœ… Passed' || echo 'âŒ Failed')" >> update-report.md

    - name: ğŸ“ Create PR for dependency updates
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: "ğŸ”„ Automated dependency updates (${{ github.event.inputs.update_type || 'patch + security' }})"
        title: "ğŸ”„ Dependency Updates: ${{ github.event.inputs.update_type || 'Patch + Security' }}"
        body: |
          ## ğŸ”„ Automated Dependency Updates
          
          **Update Type:** ${{ github.event.inputs.update_type || 'patch + security' }}
          **Generated:** $(date)
          
          ### ğŸ“‹ Summary
          This PR contains automated dependency updates with the following scope:
          
          ${{ github.event.inputs.update_type == 'patch' && '- âœ… Patch updates (bug fixes, no breaking changes)' || '' }}
          ${{ github.event.inputs.update_type == 'minor' && '- âš ï¸ Minor updates (new features, backward compatible)' || '' }}
          ${{ github.event.inputs.update_type == 'major' && '- ğŸš¨ Major updates (breaking changes - MANUAL REVIEW REQUIRED)' || '' }}
          ${{ github.event.inputs.update_type == 'security' && '- ğŸ›¡ï¸ Security updates only' || '' }}
          ${{ github.event.inputs.update_type == '' && '- âœ… Patch updates + ğŸ›¡ï¸ Security fixes' || '' }}
          
          ### ğŸ§ª Test Results
          - Build Status: $(npm run build > /dev/null 2>&1 && echo 'âœ… Passed' || echo 'âŒ Failed - Manual review required')
          - Test Status: $(npm run test > /dev/null 2>&1 && echo 'âœ… Passed' || echo 'âŒ Failed - Manual review required')
          
          ### ğŸ“¦ Changed Files
          - package.json
          - package-lock.json
          
          ### âš ï¸ Review Notes
          ${{ github.event.inputs.update_type == 'major' && 'ğŸš¨ **MAJOR UPDATES DETECTED** - This PR requires careful manual review for breaking changes.' || '' }}
          
          **Auto-generated by KONIVRER Automation System**
        branch: automation/dependency-updates-${{ github.event.inputs.update_type || 'patch' }}
        delete-branch: true
        labels: |
          dependencies
          automation
          ${{ github.event.inputs.update_type == 'major' && 'breaking-change' || 'enhancement' }}
